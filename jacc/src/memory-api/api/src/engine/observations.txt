â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            OBSERVATION REGENERATION FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚   TRIGGER: Sau khi retain() lÆ°u facts má»›i                                               â”‚
â”‚                                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 1: XÃ¡c Ä‘á»‹nh entities cáº§n regenerate (trong retain transaction)              â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ â€¢ Count mentions per entity trong batch vá»«a lÆ°u                                   â”‚  â”‚
â”‚   â”‚ â€¢ Chá»n TOP 5 entities Ä‘Æ°á»£c mention nhiá»u nháº¥t                                     â”‚  â”‚
â”‚   â”‚ â€¢ Chá»‰ xá»­ lÃ½ entities cÃ³ >= 5 facts trong database                                â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ Query:                                                                            â”‚  â”‚
â”‚   â”‚   SELECT entity_id, COUNT(*) FROM unit_entities                                   â”‚  â”‚
â”‚   â”‚   JOIN memory_units ON ...                                                        â”‚  â”‚
â”‚   â”‚   WHERE bank_id = $1                                                              â”‚  â”‚
â”‚   â”‚   GROUP BY entity_id                                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                   â”‚
â”‚                                      â–¼                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 2: Láº¥y facts liÃªn quan Ä‘áº¿n entity                                           â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ SELECT mu.text, mu.context, mu.occurred_start, mu.fact_type                       â”‚  â”‚
â”‚   â”‚ FROM memory_units mu                                                              â”‚  â”‚
â”‚   â”‚ JOIN unit_entities ue ON mu.id = ue.unit_id                                       â”‚  â”‚
â”‚   â”‚ WHERE mu.bank_id = $1                                                             â”‚  â”‚
â”‚   â”‚   AND ue.entity_id = $2                                                           â”‚  â”‚
â”‚   â”‚   AND mu.fact_type IN ('world', 'experience')  -- KhÃ´ng láº¥y observations cÅ©      â”‚  â”‚
â”‚   â”‚ ORDER BY mu.occurred_start DESC                                                   â”‚  â”‚
â”‚   â”‚ LIMIT 50                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                   â”‚
â”‚                                      â–¼                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 3: LLM Extract Observations                                                 â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ observations = await observation_utils.extract_observations_from_facts(           â”‚  â”‚
â”‚   â”‚     llm_config,                                                                   â”‚  â”‚
â”‚   â”‚     entity_name="John",                                                           â”‚  â”‚
â”‚   â”‚     facts=[fact1, fact2, ...]                                                     â”‚  â”‚
â”‚   â”‚ )                                                                                 â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ LLM Prompt (simplified):                                                          â”‚  â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚   â”‚ â”‚ Given these facts about "John":                                             â”‚  â”‚  â”‚
â”‚   â”‚ â”‚ - John visited Paris last summer                                            â”‚  â”‚  â”‚
â”‚   â”‚ â”‚ - John works at Google as a software engineer                               â”‚  â”‚  â”‚
â”‚   â”‚ â”‚ - John loves Python programming                                             â”‚  â”‚  â”‚
â”‚   â”‚ â”‚                                                                             â”‚  â”‚  â”‚
â”‚   â”‚ â”‚ Extract 3-5 concise observations that summarize key information about John â”‚  â”‚  â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ OUTPUT:                                                                           â”‚  â”‚
â”‚   â”‚   ["John is a software engineer at Google",                                       â”‚  â”‚
â”‚   â”‚    "John has traveled to Paris",                                                  â”‚  â”‚
â”‚   â”‚    "John is passionate about Python programming"]                                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                   â”‚
â”‚                                      â–¼                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 4: DELETE old observations                                                  â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ DELETE FROM memory_units                                                          â”‚  â”‚
â”‚   â”‚ WHERE id IN (                                                                     â”‚  â”‚
â”‚   â”‚     SELECT mu.id                                                                  â”‚  â”‚
â”‚   â”‚     FROM memory_units mu                                                          â”‚  â”‚
â”‚   â”‚     JOIN unit_entities ue ON mu.id = ue.unit_id                                   â”‚  â”‚
â”‚   â”‚     WHERE mu.bank_id = $1                                                         â”‚  â”‚
â”‚   â”‚       AND mu.fact_type = 'observation'  -- Only delete observations!             â”‚  â”‚
â”‚   â”‚       AND ue.entity_id = $2                                                       â”‚  â”‚
â”‚   â”‚ )                                                                                 â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ âš ï¸ Quan trá»ng: Chá»‰ xÃ³a observations cÅ©, KHÃ”NG xÃ³a facts!                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                                   â”‚
â”‚                                      â–¼                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Step 5: INSERT new observations                                                  â”‚  â”‚
â”‚   â”‚                                                                                   â”‚  â”‚
â”‚   â”‚ â€¢ Generate embeddings for observations (batch)                                    â”‚  â”‚
â”‚   â”‚ â€¢ INSERT INTO memory_units (..., fact_type='observation') for each obs           â”‚  â”‚
â”‚   â”‚ â€¢ INSERT INTO unit_entities to link observation â†” entity                         â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                          â”‚
â”‚   ğŸ“‹ Táº¤T Cáº¢ TRONG CÃ™NG 1 TRANSACTION (ATOMIC)                                           â”‚
â”‚                                                                                          â”‚
â”‚   Náº¿u báº¥t ká»³ step nÃ o fail â†’ ROLLBACK â†’ Facts má»›i cÅ©ng bá»‹ rollback                      â”‚
â”‚   Äiá»u nÃ y Ä‘áº£m báº£o data consistency giá»¯a facts vÃ  observations                          â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜